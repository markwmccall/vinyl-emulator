{% extends "base.html" %}
{% block title %} — {{ track.name }}{% endblock %}

{% block content %}
<div class="album-page">
  <div class="album-header">
    <img src="{{ track.artwork_url }}" alt="{{ track.album }}" class="album-art">
    <div class="album-meta">
      <h1>{{ track.name }}</h1>
      <p class="artist">{{ track.artist }}</p>
      <p class="track-subtitle">{{ track.album }}</p>
      <p class="tag-string">Tag: <code>apple:track:{{ track_id }}</code></p>

      <div class="action-btns">
        <button id="play-btn" class="play-btn" data-track-id="{{ track_id }}">
          ▶ Play Now
        </button>
        <button id="write-btn" class="write-btn" data-track-id="{{ track_id }}">
          Write to Tag
        </button>
      </div>
      <div id="transport-btns" class="action-btns transport-btns">
        <button id="pause-btn" class="pause-btn">⏸ Pause</button>
        <button id="stop-btn" class="stop-btn">⏹ Stop</button>
      </div>
      <p id="action-status" class="write-status"></p>
    </div>
  </div>
</div>

<script>
  const status = document.getElementById('action-status');

  async function postAction(url, body, btn, busyText, doneText, successMsg) {
    btn.disabled = true;
    btn.textContent = busyText;
    status.textContent = '';
    status.className = 'write-status';
    try {
      const resp = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body),
      });
      const data = await resp.json();
      if (!resp.ok) {
        btn.textContent = doneText;
        btn.disabled = false;
        status.textContent = data.error || 'Something went wrong.';
        status.className = 'write-status error';
        return;
      }
      btn.textContent = doneText;
      btn.disabled = false;
      status.textContent = successMsg(data);
      status.className = 'write-status success';
    } catch (e) {
      btn.textContent = doneText;
      btn.disabled = false;
      status.textContent = 'Error — check the console.';
      status.className = 'write-status error';
    }
  }

  const transportBtns = document.getElementById('transport-btns');

  document.getElementById('play-btn').addEventListener('click', function() {
    postAction('/play', {track_id: this.dataset.trackId}, this, 'Playing…', '▶ Play Now',
      () => { transportBtns.style.display = 'flex'; return '✓ Playing on Sonos'; });
  });

  document.getElementById('pause-btn').addEventListener('click', function() {
    postAction('/transport', {action: 'pause'}, this, 'Pausing…', '⏸ Pause',
      () => 'Paused');
  });

  document.getElementById('stop-btn').addEventListener('click', function() {
    postAction('/transport', {action: 'stop'}, this, 'Stopping…', '⏹ Stop',
      () => { transportBtns.style.display = 'none'; return 'Stopped'; });
  });

  document.getElementById('write-btn').addEventListener('click', function() {
    postAction('/write-tag', {track_id: this.dataset.trackId}, this, 'Writing…', 'Write to Tag',
      data => '✓ Written: ' + data.written);
  });
</script>
{% endblock %}
