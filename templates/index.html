{% extends "base.html" %}
{% block title %} — Search{% endblock %}

{% block content %}
<div class="search-page">
  <div class="search-bar">
    <input type="text" id="search-input" placeholder="Artist, album, or song…" autofocus>
    <button id="clear-btn" class="clear-btn" style="display:none" aria-label="Clear">&times;</button>
  </div>

  <div class="search-tabs">
    <button class="tab-btn active" data-type="album">Albums</button>
    <button class="tab-btn" data-type="song">Songs</button>
  </div>

  <div id="results" class="results-grid"></div>
</div>

<script>
  const input = document.getElementById('search-input');
  const clearBtn = document.getElementById('clear-btn');
  const results = document.getElementById('results');

  clearBtn.addEventListener('click', () => {
    input.value = '';
    results.innerHTML = '';
    clearBtn.style.display = 'none';
    input.focus();
  });
  const tabBtns = document.querySelectorAll('.tab-btn');
  let timer;
  let activeType = 'album';

  tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      tabBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      activeType = btn.dataset.type;
      const q = input.value.trim();
      if (q) fetchResults(q);
    });
  });

  input.addEventListener('input', () => {
    clearTimeout(timer);
    const q = input.value.trim();
    clearBtn.style.display = q ? 'flex' : 'none';
    if (!q) { results.innerHTML = ''; return; }
    timer = setTimeout(() => fetchResults(q), 300);
  });

  // Pre-fill from ?q= URL param (e.g. from Now Playing search link)
  const urlQ = new URLSearchParams(window.location.search).get('q');
  if (urlQ && !input.value.trim()) { input.value = urlQ; }

  // Re-run search if the browser restored a value or ?q= param was set
  if (input.value.trim()) { clearBtn.style.display = 'flex'; fetchResults(input.value.trim()); }

  async function fetchResults(q) {
    results.innerHTML = '<p class="loading">Searching…</p>';
    const resp = await fetch('/search?q=' + encodeURIComponent(q) + '&type=' + activeType);
    const items = await resp.json();
    if (!items.length) {
      results.innerHTML = '<p class="empty">No results.</p>';
      return;
    }
    if (activeType === 'album') {
      results.innerHTML = items.map(a => `
        <a href="/album/${a.id}" class="album-card">
          <img src="${a.artwork_url}" alt="${a.name}">
          <div class="album-info">
            <div class="album-name">${a.name}</div>
            <div class="album-artist">${a.artist}</div>
          </div>
        </a>
      `).join('');
    } else {
      results.innerHTML = items.map(s => `
        <a href="/track/${s.id}" class="album-card">
          <img src="${s.artwork_url}" alt="${s.name}">
          <div class="album-info">
            <div class="album-name">${s.name}</div>
            <div class="album-artist">${s.artist}</div>
            <div class="result-album">${s.album}</div>
          </div>
        </a>
      `).join('');
    }
  }
</script>
{% endblock %}
