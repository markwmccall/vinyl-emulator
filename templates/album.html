{% extends "base.html" %}
{% block title %} — {{ tracks[0].album }}{% endblock %}

{% block content %}
<div class="album-page">
  <div class="album-header">
    <img src="{{ tracks[0].artwork_url }}" alt="{{ tracks[0].album }}" class="album-art">
    <div class="album-meta">
      <h1>{{ tracks[0].album }}</h1>
      <p class="artist">{{ tracks[0].artist }}</p>
      <p class="tag-string">Tag: <code>apple:{{ album_id }}</code></p>

      <div class="action-btns">
        <button id="play-btn" class="play-btn" data-album-id="{{ album_id }}">
          ▶ Play Now
        </button>
        <button id="write-btn" class="write-btn" data-album-id="{{ album_id }}">
          Write to Tag
        </button>
      </div>
      <div id="transport-btns" class="action-btns transport-btns">
        <button id="pause-btn" class="pause-btn">⏸ Pause</button>
        <button id="stop-btn" class="stop-btn">⏹ Stop</button>
      </div>
      <p id="action-status" class="write-status"></p>
    </div>
  </div>

  <ol class="track-list">
    {% for track in tracks %}
    <li class="track">
      <span class="track-num">{{ track.track_number }}</span>
      <a href="/track/{{ track.track_id }}" class="track-name">{{ track.name }}</a>
    </li>
    {% endfor %}
  </ol>
</div>

<script>
  const status = document.getElementById('action-status');

  async function postAction(url, body, btn, busyText, doneText, successMsg) {
    btn.disabled = true;
    btn.textContent = busyText;
    status.textContent = '';
    status.className = 'write-status';
    try {
      const resp = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body),
      });
      const data = await resp.json();
      if (!resp.ok) {
        btn.textContent = doneText;
        btn.disabled = false;
        status.textContent = data.error || 'Something went wrong.';
        status.className = 'write-status error';
        return;
      }
      btn.textContent = doneText;
      btn.disabled = false;
      status.textContent = successMsg(data);
      status.className = 'write-status success';
    } catch (e) {
      btn.textContent = doneText;
      btn.disabled = false;
      status.textContent = 'Error — check the console.';
      status.className = 'write-status error';
    }
  }

  const transportBtns = document.getElementById('transport-btns');

  document.getElementById('play-btn').addEventListener('click', function() {
    postAction('/play', {album_id: this.dataset.albumId}, this, 'Playing…', '▶ Play Now',
      () => { transportBtns.style.display = 'flex'; return '✓ Playing on Sonos'; });
  });

  document.getElementById('pause-btn').addEventListener('click', function() {
    postAction('/transport', {action: 'pause'}, this, 'Pausing…', '⏸ Pause',
      () => 'Paused');
  });

  document.getElementById('stop-btn').addEventListener('click', function() {
    postAction('/transport', {action: 'stop'}, this, 'Stopping…', '⏹ Stop',
      () => { transportBtns.style.display = 'none'; return 'Stopped'; });
  });

  document.getElementById('write-btn').addEventListener('click', function() {
    postAction('/write-tag', {album_id: this.dataset.albumId}, this, 'Writing…', 'Write to Tag',
      data => '✓ Written: ' + data.written);
  });
</script>
{% endblock %}
