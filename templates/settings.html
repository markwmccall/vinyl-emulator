{% extends "base.html" %}
{% block title %} — Settings{% endblock %}

{% block content %}
<div class="settings-page">
  <h1>Settings</h1>

  {% if config.nfc_mode == 'pn532' %}
  <div class="player-control-section">
    <h2>Player</h2>
    <p>Stop the player before writing tags. Restart it when done.</p>
    <div class="player-status-row">
      <span id="player-status-badge" class="player-badge">Checking…</span>
      <button id="player-stop-btn" type="button" disabled>Stop Player</button>
      <button id="player-start-btn" type="button" disabled>Start Player</button>
    </div>
  </div>
  {% endif %}

  {% if saved %}
  <div class="banner success">Settings saved.</div>
  {% endif %}

  <form method="POST" action="/settings">
    <div class="field">
      <label for="speaker_ip">Sonos Speaker IP</label>
      <div class="speaker-row">
        <input type="text" id="speaker_ip" name="speaker_ip"
               value="{{ config.speaker_ip }}" placeholder="10.0.0.12">
        <button type="button" id="discover-btn">Discover</button>
      </div>
      <select id="speaker-select" style="display:none">
        <option value="">— select a speaker —</option>
      </select>
      <span id="discover-status" class="hint"></span>
    </div>

    <div class="field">
      <label for="sn">Apple Music Account (sn)</label>
      <div class="speaker-row">
        <input type="text" id="sn" name="sn" value="{{ config.sn }}">
        <button type="button" id="detect-sn-btn">Detect</button>
      </div>
      <span id="detect-sn-status" class="hint">Detect requires at least one Apple Music favorite saved in the Sonos app. If detection fails, try small numbers like 3 or 5. To confirm the value is correct, save and try playing an album or track.</span>
    </div>

    <div class="field">
      <label for="nfc_mode">NFC Mode</label>
      <select id="nfc_mode" name="nfc_mode">
        <option value="mock" {% if config.nfc_mode == 'mock' %}selected{% endif %}>
          mock (Mac testing)
        </option>
        <option value="pn532" {% if config.nfc_mode == 'pn532' %}selected{% endif %}>
          pn532 (Raspberry Pi)
        </option>
      </select>
    </div>

    <button type="submit" class="save-btn">Save</button>
  </form>
</div>

<script>
  const discoverBtn = document.getElementById('discover-btn');
  const speakerSelect = document.getElementById('speaker-select');
  const speakerIpInput = document.getElementById('speaker_ip');
  const discoverStatus = document.getElementById('discover-status');

  discoverBtn.addEventListener('click', async () => {
    discoverBtn.disabled = true;
    discoverStatus.textContent = 'Discovering speakers… (this takes ~10s)';
    speakerSelect.style.display = 'none';
    try {
      const resp = await fetch('/speakers');
      const speakers = await resp.json();
      discoverStatus.textContent = '';
      if (!speakers.length) {
        discoverStatus.textContent = 'No speakers found.';
        discoverBtn.disabled = false;
        return;
      }
      speakerSelect.innerHTML = '<option value="">— select a speaker —</option>' +
        speakers.map(s => `<option value="${s.ip}">${s.name} (${s.ip})</option>`).join('');
      speakerSelect.style.display = 'block';
      discoverBtn.disabled = false;
    } catch (e) {
      discoverStatus.textContent = 'Discovery failed.';
      discoverBtn.disabled = false;
    }
  });

  const detectSnBtn = document.getElementById('detect-sn-btn');
  const snInput = document.getElementById('sn');
  const detectSnStatus = document.getElementById('detect-sn-status');

  detectSnBtn.addEventListener('click', async () => {
    detectSnBtn.disabled = true;
    detectSnStatus.textContent = 'Detecting…';
    const ip = speakerIpInput.value.trim();
    const url = ip ? `/detect-sn?speaker_ip=${encodeURIComponent(ip)}` : '/detect-sn';
    try {
      const resp = await fetch(url);
      const data = await resp.json();
      if (resp.ok) {
        snInput.value = data.sn;
        detectSnStatus.textContent = `Detected: ${data.sn}`;
      } else {
        detectSnStatus.textContent = data.error || 'Not found — enter 3 or 5 manually';
      }
    } catch (e) {
      detectSnStatus.textContent = 'Detection failed.';
    }
    detectSnBtn.disabled = false;
  });

  speakerSelect.addEventListener('change', () => {
    if (speakerSelect.value) {
      speakerIpInput.value = speakerSelect.value;
    }
  });

  // Player controls (pn532 mode only)
  const statusBadge = document.getElementById('player-status-badge');
  const stopBtn = document.getElementById('player-stop-btn');
  const startBtn = document.getElementById('player-start-btn');

  if (statusBadge) {
    async function fetchPlayerStatus() {
      try {
        const resp = await fetch('/player/status');
        const data = await resp.json();
        const active = data.status === 'active';
        statusBadge.textContent = active ? 'Running' : 'Stopped';
        statusBadge.className = 'player-badge ' + (active ? 'badge-running' : 'badge-stopped');
        stopBtn.disabled = !active;
        startBtn.disabled = active;
      } catch (e) {
        statusBadge.textContent = 'Unknown';
        statusBadge.className = 'player-badge badge-unknown';
      }
    }

    async function controlPlayer(action) {
      stopBtn.disabled = true;
      startBtn.disabled = true;
      statusBadge.textContent = action === 'stop' ? 'Stopping…' : 'Starting…';
      await fetch('/player/control', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({action}),
      });
      // Give systemd a moment then re-check
      setTimeout(fetchPlayerStatus, 1500);
    }

    stopBtn.addEventListener('click', () => controlPlayer('stop'));
    startBtn.addEventListener('click', () => controlPlayer('start'));
    fetchPlayerStatus();
  }
</script>
{% endblock %}
